-------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\Jorgec\ISEAK mw report 2022\00. Data processing\00. MCVL\log\01. Harmonise 
> affiliation data 20230122.log
  log type:  text
 opened on:  22 Jan 2023, 22:52:34

. 
.         
. ********************************************************************************
. * C. Load and prepare the data
. ********************************************************************************
.         
.         use "$dta/00. Affiliation data.dta", clear      

.         
.         * Fix open-ended contracts (2099)
.         replace fbaja = d(31dec2019) if fbaja == d(31dec2099)
(705,861 real changes made)

.         
.         * Generate labels
.         
.                 ** Economic sector
.                 tostring cnae93, replace
cnae93 was int now str3

.                 replace cnae93 = "0" + cnae93 if length(cnae93) == 2
(654,787 real changes made)

.                 replace cnae93 = "00" + cnae93 if length(cnae93) == 1 & cnae93 == "0"
(4,534,027 real changes made)

.                 assert length(cnae93) == 3

.                 
.                 qui {

.                 
.                 drop cnae93

.                 ren cnae09 cnae

.         
. ********************************************************************************
. * D. Generate relevant variables
. ********************************************************************************        
.         
.         * Employed
.         gen employed = (!inrange(trl, 751, 756) & !inrange(trl, 721, 740)) if !inrange(re
> gcot, 512, 540) 
(608,255 missing values generated)

. 
.         * Number of workers
.         gen nworkers = 1 if numtrab >= 1 & numtrab < 10 
(25,089,701 missing values generated)

.         replace nworkers = 2 if numtrab >= 10 & numtrab <= 49
(2,192,564 real changes made)

.         replace nworkers = 3 if numtrab >= 50 & numtrab <= 249
(2,200,828 real changes made)

.         replace nworkers = 4 if numtrab >= 250 & numtrab < .
(8,612,114 real changes made)

.         
.         label define nworkers 1 "<10 trab" 2 "10-49 trab" 3 "50-249 trab" 4 ">= 250"

.         label values nworkers nworkers 

.         
.         *Cutoff dates
.         gen m = 1

.         sort m

.         merge m:1 m using "$dta\_AUX. Cutoff dates.dta", nogen

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                        27,316,707  
    -----------------------------------------

.         drop m

.                 
. ********************************************************************************
. * E. Filter the data
. ********************************************************************************        
.         
.         * Keep only spells between Jan-18 and Dec-19
.         keep if inrange(2018, year(falta), year(fbaja)) | inrange(2019, year(falta), year
> (fbaja))
(23,746,697 observations deleted)

.         qui unique identpers

.         di as txt "Number of initial workers:" %5.0fc `r(unique)'       
Number of initial workers:949233

.         
.         * Keep only the second Tuesday of each month
.         gen t1 = 1 if inrange(date1,falta,fbaja)
(2,750,647 missing values generated)

.         local filter = "inrange(date1,falta,fbaja)"

.         
.         forval x = 2/24 {
  2.                 local filter = "`filter'" + " | inrange(date`x',falta,fbaja)"
  3.                 
.                 gen t`x' = .
  4.                 replace t`x' = 1 if inrange(date`x',falta,fbaja)
  5.         }
(3,570,010 missing values generated)
(821,706 real changes made)
(3,570,010 missing values generated)
(823,358 real changes made)
(3,570,010 missing values generated)
(827,320 real changes made)
(3,570,010 missing values generated)
(833,580 real changes made)
(3,570,010 missing values generated)
(838,673 real changes made)
(3,570,010 missing values generated)
(842,885 real changes made)
(3,570,010 missing values generated)
(838,941 real changes made)
(3,570,010 missing values generated)
(838,405 real changes made)
(3,570,010 missing values generated)
(847,013 real changes made)
(3,570,010 missing values generated)
(850,823 real changes made)
(3,570,010 missing values generated)
(859,935 real changes made)
(3,570,010 missing values generated)
(854,179 real changes made)
(3,570,010 missing values generated)
(856,676 real changes made)
(3,570,010 missing values generated)
(858,141 real changes made)
(3,570,010 missing values generated)
(865,032 real changes made)
(3,570,010 missing values generated)
(870,771 real changes made)
(3,570,010 missing values generated)
(872,926 real changes made)
(3,570,010 missing values generated)
(877,709 real changes made)
(3,570,010 missing values generated)
(871,293 real changes made)
(3,570,010 missing values generated)
(869,563 real changes made)
(3,570,010 missing values generated)
(873,538 real changes made)
(3,570,010 missing values generated)
(874,535 real changes made)
(3,570,010 missing values generated)
(881,842 real changes made)

.         
.         keep if `filter' 
(1,186,415 observations deleted)

.         
.         qui unique identpers

.         di as txt "Number of workers wiht a spell in the second Tuesday of each month:" %
> 5.0fc `r(unique)'      
Number of workers wiht a spell in the second Tuesday of each month:937870

. 
.         * Check for multijobs = Drop if its working as a self and nonself employee at tha
> t time
.         gen auto = (inrange(regcot, 512, 540))

.         gen non_auto = (!inrange(regcot, 512, 540)) if !inrange(trl, 751, 756)
(469,113 missing values generated)

.         gen flag = 0

. 
.         forval x = 1/24 {
  2.                 gen auto`x' = (auto == 1 & t`x' == 1)
  3.                 gen non_auto`x' = (non_auto == 1 & t`x' == 1) 
  4.                 bys identpers: egen max_auto = max(auto`x')
  5.                 bys identpers: egen max_non_auto = max(non_auto`x')
  6.                 egen check`x' = rowmean(max_auto max_non_auto)
  7.                 replace flag = 1 if check`x' == 1 & !mi(auto`x') & !mi(non_auto`x')
  8.                 drop max_* check* auto`x' non_auto`x'
  9.         }                       
(22,711 real changes made)
(3,384 real changes made)
(2,440 real changes made)
(2,488 real changes made)
(2,436 real changes made)
(3,060 real changes made)
(3,081 real changes made)
(2,161 real changes made)
(1,795 real changes made)
(2,447 real changes made)
(2,130 real changes made)
(1,935 real changes made)
(1,276 real changes made)
(1,909 real changes made)
(1,598 real changes made)
(2,014 real changes made)
(1,967 real changes made)
(1,801 real changes made)
(2,129 real changes made)
(1,567 real changes made)
(1,377 real changes made)
(1,967 real changes made)
(1,793 real changes made)
(1,624 real changes made)

. 
.         qui unique identpers if flag == 1

.         di as txt "Number of workers dropped with self and not self simultaneos jobs:" %5
> .0fc `r(unique)'                       
Number of workers dropped with self and not self simultaneos jobs:19122

.         drop if flag == 1
(71,090 observations deleted)

.         drop flag

.         
.         * Keep only workers when a general regime, household employees or agrarian activi
> ty contract
.         gen to_drop = (inrange(regcot, 521,540) | inrange(regcot, 721, 950))

.         bys identpers: egen max_to_drop = max(to_drop)

.         qui unique identpers if max_to_drop == 1

.         di as txt "Number of workers with a special regime to be dropped:" %5.0fc `r(uniq
> ue)'           
Number of workers with a special regime to be dropped:145022

.         drop if max_to_drop == 1
(220,683 observations deleted)

.         drop max_to_drop to_drop

. 
.         * Check for multijobs = Have multiple jobs at the same time
.         gen flag = .
(2,091,822 missing values generated)

.         forval x = 1/24 {
  2.                 cap drop total
  3.                 gen emp`x' = 1 if t`x' == 1 & employed == 1
  4.                 bys identpers : egen total = total(emp`x')
  5.                 replace flag = 1 if total > 1 & total < . 
  6.         }
(1,502,054 missing values generated)
(162,952 real changes made)
(1,499,470 missing values generated)
(26,435 real changes made)
(1,496,424 missing values generated)
(15,724 real changes made)
(1,490,833 missing values generated)
(15,462 real changes made)
(1,482,599 missing values generated)
(15,902 real changes made)
(1,477,656 missing values generated)
(17,429 real changes made)
(1,477,347 missing values generated)
(16,555 real changes made)
(1,484,708 missing values generated)
(12,346 real changes made)
(1,482,642 missing values generated)
(9,439 real changes made)
(1,474,833 missing values generated)
(15,289 real changes made)
(1,474,823 missing values generated)
(12,230 real changes made)
(1,467,578 missing values generated)
(12,024 real changes made)
(1,474,586 missing values generated)
(8,017 real changes made)
(1,472,912 missing values generated)
(8,720 real changes made)
(1,469,134 missing values generated)
(7,194 real changes made)
(1,461,764 missing values generated)
(8,140 real changes made)
(1,454,029 missing values generated)
(9,068 real changes made)
(1,452,433 missing values generated)
(8,256 real changes made)
(1,452,570 missing values generated)
(9,650 real changes made)
(1,461,997 missing values generated)
(8,522 real changes made)
(1,460,352 missing values generated)
(6,261 real changes made)
(1,456,413 missing values generated)
(8,447 real changes made)
(1,458,886 missing values generated)
(6,867 real changes made)
(1,453,410 missing values generated)
(7,024 real changes made)

.         
.         qui unique identpers if flag == 1

.         di as txt "Number of individuals dropped for being multijob workers:" %5.0fc `r(u
> nique)'        
Number of individuals dropped for being multijob workers:74213

.         
.         drop if flag == 1       
(427,953 observations deleted)

.         drop flag

.         
.         * Drop unemployment spells
.         drop if employed == 0
(373,487 observations deleted)

.         
.         *Save information about changes in job spells to update later on
.         preserve

.                 
.                 keep identpers identccc2 falta fbaja tipconmod1 cparcmod1 tipconmod2 cpar
> cmod2 grupcotmod1 tipcont fmod*

.                 
.                 destring tipconmod1 cparcmod1 tipconmod2 cparcmod2 grupcotmod1 tipcont, r
> eplace
tipconmod1: all characters numeric; replaced as int
(899121 missing values generated)
cparcmod1: all characters numeric; replaced as int
(899121 missing values generated)
tipconmod2: all characters numeric; replaced as int
(1019304 missing values generated)
cparcmod2: all characters numeric; replaced as int
(1019304 missing values generated)
grupcotmod1: all characters numeric; replaced as byte
(1163963 missing values generated)
tipcont already numeric; no replace

.                 
.                 bys identpers identccc2 falta fbaja : gen dup = _N

.                 assert dup == 1

.                 drop dup

.                 
.                 sort identpers identccc2 falta fbaja  

.                 tempfile changes_info

.                 save `changes_info', replace    
(note: file C:\PROGRA~3\Temp\STATA-~1\JORGE_~1\ST_2be0_000002.tmp not found)
file C:\PROGRA~3\Temp\STATA-~1\JORGE_~1\ST_2be0_000002.tmp saved

.         
.         restore

.         
.         * Save information about dates
.         preserve

.         
.                 use "$dta\_AUX. Cutoff dates.dta", clear

.                 
.                 reshape long date, i(m) j(t)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                        1   ->      24
Number of variables                  25   ->       3
j variable (24 values)                    ->   t
xij variables:
                 date1 date2 ... date24   ->   date
-----------------------------------------------------------------------------

.                 
.                 drop m

.                 
.                 sort t

.         
.                 tempfile dates

.                 save `dates', replace
(note: file C:\PROGRA~3\Temp\STATA-~1\JORGE_~1\ST_2be0_000004.tmp not found)
file C:\PROGRA~3\Temp\STATA-~1\JORGE_~1\ST_2be0_000004.tmp saved

.         
.         restore

.         
. ********************************************************************************
. * F. Set the dataset in long form
. ********************************************************************************        
. 
.         * Keep relevant variables
.         keep identpers identccc2 nworkers t1-t24 falta fbaja coefparc cnae grupcot domccc
> 2 regcot numtrab

.         
.         ren (identccc2 domccc2) (identccc domccc)

.         
.         * Prepare data to reshape
.         qui ds t1-t24 identpers identccc, not

.         local varlist = r(varlist)

. 
.         foreach var of local varlist {
  2.                 forval x = 1/24 {
  3.                         qui gen `var'`x' = `var' if t`x' == 1
  4.                 }
  5.                 qui compress
  6.                 drop `var'
  7.         }

.         
.         forval x = 1/24 {
  2.                 qui gen identccc`x' = identccc if t`x' == 1
  3.                 qui compress
  4.         }       

.         
.         drop t1-t24 identccc

.         
.         preserve

.         
.                 keep identpers identccc*

.                 qui compress

.                 
.                 collapse (firstnm) identccc*,by(identpers)

.                 
.                 sort identpers

.                 
.                 tempfile firms

.                 save `firms', replace
(note: file C:\PROGRA~3\Temp\STATA-~1\JORGE_~1\ST_2be0_000006.tmp not found)
file C:\PROGRA~3\Temp\STATA-~1\JORGE_~1\ST_2be0_000006.tmp saved

.         
.         restore

.         
.         drop identccc*

.         
.         qui ds identpers, not

.         local varlist_wide = r(varlist) 

.         
.         qui compress

.         
.         * Collapse the data to have one obs per individual
.         gcollapse (max) `varlist_wide', by(identpers)

.         
.         sort identpers

.         merge 1:1 identpers using `firms', nogen 

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           670,650  
    -----------------------------------------

. 
.         * Reshape in long format
.         greshape long `varlist' identccc, i(identpers) j(t)
(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24)
(note: cannot preserve labels when reshaping long)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                  670,650   ->   16,095,600           
Number of variables                  241  ->   12                   
j (24 values)                             ->   t
xij variables:
           regcot1 regcot2 ... regcot24   ->   regcot
        grupcot1 grupcot2 ... grupcot24   ->   grupcot
     coefparc1 coefparc2 ... coefparc24   ->   coefparc
           domccc1 domccc2 ... domccc24   ->   domccc
                 cnae1 cnae2 ... cnae24   ->   cnae
        numtrab1 numtrab2 ... numtrab24   ->   numtrab
              falta1 falta2 ... falta24   ->   falta
              fbaja1 fbaja2 ... fbaja24   ->   fbaja
     nworkers1 nworkers2 ... nworkers24   ->   nworkers
     identccc1 identccc2 ... identccc24   ->   identccc
-----------------------------------------------------------------------------

. 
.         ren (identccc domccc) (identccc2 domccc2)

.         
. ********************************************************************************
. * G. Update job spells with information about changes
. ********************************************************************************         
>        
.                 
.         * Get updated data
.         sort identpers identccc2 falta fbaja

.         merge m:1 identpers identccc2 falta fbaja using `changes_info'
(note: variable falta was int, now float to accommodate using data's values)
(note: variable fbaja was int, now float to accommodate using data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                     3,515,971
        from master                 3,515,971  (_merge==1)
        from using                          0  (_merge==2)

    matched                        12,579,629  (_merge==3)
    -----------------------------------------

.         
.         assert mi(falta) & mi(fbaja) if _m == 1

.         keep if _m == 1 | _m == 3
(0 observations deleted)

.         drop _m

.         
.         * Get dates
.         merge m:1 t using `dates', nogen keep(3)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                        16,095,600  
    -----------------------------------------

.         
.         * Update partiality coefficient
.         replace coefparc = cparcmod1 if !mi(falta) & fmodcont1>=date & !mi(cparcmod1)
(244,738 real changes made)

.         replace coefparc = cparcmod2 if !mi(falta) & fmodcont2>=date & fmodcont1<date
(1,280,981 real changes made, 1,135,920 to missing)

. 
.         * Update type of contract
.         replace tipcont = tipconmod1 if !mi(falta) & fmodcont1>=date & !mi(tipconmod1)
(567,167 real changes made)

.         replace tipcont = tipconmod1 if !mi(falta) & fmodcont2>=date & fmodcont1<date   
(2,048,393 real changes made)

.         
.         * Update contribution group
.         replace grupcot = grupcotmod1 if !mi(falta) & fmodgrup1>=date & !mi(grupcotmod1)
(200,714 real changes made)

.         
.         drop tipconmod1 cparcmod1 cparcmod2 grupcotmod1 tipconmod2 fmodcont1 fmodcont2 fm
> odgrup1 date 

.         
. ********************************************************************************
. * H. Generate additional variables, format and save
. ********************************************************************************        
.         
.         *Dummy of employment
.         gen employed = (!mi(falta))

. 
.         *Dummy of Permanent contract
.         gen byte permanent = (tipcont==1|tipcont==3|tipcont==8|tipcont==9|tipcont==11|tip
> cont==18|tipcont==20|/*
>         */tipcont==23|tipcont==28|tipcont==38|tipcont==63|tipcont==35|(tipcont>=45 & tipc
> ont<=48)|/*
>         */(tipcont>=40 & tipcont<=44)|tipcont==49|tipcont==50|tipcont==52|tipcont==61|tip
> cont==65|tipcont==81|/*
>         */(tipcont>=59 & tipcont<=62)|(tipcont>=69 & tipcont<=71)|tipcont==80|tipcont==86
> |tipcont==88|tipcont==89|/*
>         */tipcont==91|tipcont==98|tipcont==100|tipcont==101|tipcont==102|tipcont==109|tip
> cont==130|/*
>         */tipcont==131|tipcont==139|(tipcont>=141 & tipcont<=157)|tipcont==185|tipcont==1
> 86|tipcont==189|/*
>         */(tipcont>=181 & tipcont<=184)|(tipcont>=200 & tipcont<=208)|tipcont==209|tipcon
> t==239|tipcont==289|/*
>         */(tipcont>=230 & tipcont<=238)|(tipcont>=241 & tipcont<=257)|tipcont==300|tipcon
> t==309|tipcont==389|/*
>         */(tipcont>=330 & tipcont<=357))

.         
.         replace permanent = . if employed == 0 | employed == .
(3,515,971 real changes made, 3,515,971 to missing)

.         
.         *Dummy of Temporary
.         gen byte temporary = (tipcont==4|tipcont==5|tipcont==6|tipcont==7|tipcont==10|tip
> cont==15|tipcont==14|/*
> */ tipcont==16|tipcont==17|tipcont==22|tipcont==26|tipcont==27|tipcont==25|tipcont==24|ti
> pcont==34|/*
> */ (tipcont>=30 & tipcont<=33)|tipcont==36|tipcont==37|(tipcont>=53 & tipcont<=58)|tipcon
> t==66|/*
> */ tipcont==67|tipcont==68|tipcont==64|tipcont==72|tipcont==73|tipcont==74|tipcont==76|ti
> pcont==77|/*
> */ tipcont==78|tipcont==79|tipcont==85|tipcont==87|tipcont==96|tipcont==75|tipcont==82|ti
> pcont==83|/*
> */ tipcont==84|tipcont==93|tipcont==94|tipcont==92|tipcont==95|tipcont==97|tipcont==401|/
> *
> */ tipcont==403|tipcont==408|tipcont==402|tipcont==410|tipcont==418|tipcont==420|tipcont=
> =421|/*
> */ tipcont==430|tipcont==431|tipcont==441|tipcont==450|tipcont==451|tipcont==452|tipcont=
> =457|/*
> */ tipcont==500|tipcont==503|tipcont==508|tipcont==501|tipcont==502|tipcont==510|tipcont=
> =518|/*
> */ tipcont==520|tipcont==530|tipcont==531|tipcont==540|tipcont==541|tipcont==550|tipcont=
> =551|/*
> */ tipcont==552|tipcont==557)

.         
.         replace temporary = . if employed == 0 | employed == .
(3,515,971 real changes made, 3,515,971 to missing)

.         
.                 ** For missing cases, assume a temporary contract
.                 tab tipcont if temporary == 0 & permanent == 0

    Type of |
   contract |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |  1,111,600       99.92       99.92
         19 |        245        0.02       99.94
         39 |         24        0.00       99.94
        404 |        668        0.06      100.00
------------+-----------------------------------
      Total |  1,112,537      100.00

.                 replace temporary = 1 if temporary == 0 & permanent == 0
(1,112,537 real changes made)

.                 
.                 assert permanent == 0 if temporary == 1

.                 assert temporary == 1 if permanent == 0

. 
.         * Dummy of full time
.         gen ft = (coefparc >= 750) if employed == 1
(3,515,971 missing values generated)

.         
.         * Dummy of part time
.         gen pt = (coefparc > 750 & coefparc < .) if employed == 1
(3,515,971 missing values generated)

. 
.         * Interactions
.         cap drop temporary_* permanent_*

.         
.         gen temporary_ft = temporary * ft
(3,515,971 missing values generated)

.         gen temporary_pt = temporary * pt
(3,515,971 missing values generated)

.         gen permanent_ft = permanent * ft
(3,515,971 missing values generated)

.         gen permanent_pt = permanent * pt
(3,515,971 missing values generated)

.         
.         * Skills
.         gen skill=1 if (grupcot == 1| grupcot == 2)
(13,923,156 missing values generated)

.         replace skill=2 if inrange(grupcot, 3, 7)
(4,995,073 real changes made)

.         replace skill=3 if inrange(grupcot, 8, 9)               
(3,535,364 real changes made)

. 
.         * Economic sector group
.         qui {

.         
.         label define skill 1 "High skill" 2 "Med skill" 3 "Low skill"

.         label values skill skill 

.         
.         * Formatting
.         format falta fbaja %td

.         label values nworkers nworkers 

.         
.         label var identpers "ID"

.         label var falta "Date of begin"

.         label var fbaja "Date of end"           

.         label var nworkers "Cat number of workers in FirmXmuni"

.         label var identccc2 "Firm x Muni ID"

.         label var employed "Employed"

.         label var ft "Full time"

.         label var pt "Part time"

.         label var permanent "Permanent"

.         label var temporary "Temporary"

.         label var permanent_ft "Permanent x Full time"

.         label var temporary_ft "Temporary x Full time"  

.         label var permanent_pt "Permanent x Part time"

.         label var temporary_pt "Temporary x Part time"  

.         label var cnae "Firm x Muni sector"

.         label var gcnae "Firm x Muni sector group"

.         label var coefparc "Partiality coef"

.         label var regcot "Type of regime"

.         label var t "Month"

.         label var grupcot "Contribution group"

.         label var skill "Level of skills"

.         label var domccc2 "Zip code of Firm x Muni"

.         label var numtrab "Number of workers in FirmXmuni"

.         
.         qui compress

.         sort identpers identccc2 t

.         
.         save "$dta\01. Harmonised affiliation data.dta", replace
file E:\Jorgec\ISEAK mw report 2022\00. Data processing\00. MCVL\dta\01. Harmonised affilia
> tion data.dta saved

.         
. * End of this dofile
. cap log close
